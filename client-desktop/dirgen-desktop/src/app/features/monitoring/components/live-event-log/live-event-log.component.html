<div class="live-event-log">
  <div class="log-header">
    <mat-icon>assignment</mat-icon>
    <h3>Log de Eventos en Tiempo Real</h3>
    @if (webSocketState && webSocketState.messages && webSocketState.messages.length) {
      <mat-chip class="message-counter">{{ webSocketState.messages.length }}</mat-chip>
    }
  </div>

  <div class="log-container" #logContainer>
    @if (!webSocketState || !webSocketState.messages || !webSocketState.messages.length) {
      <div class="empty-log">
        <mat-icon>inbox</mat-icon>
        <p>No hay eventos aún</p>
        <small>Los mensajes aparecerán aquí cuando inicie una ejecución</small>
      </div>
    } @else {
      <!-- Event Log Entries with Expansion Panels -->
      <mat-accordion class="log-entries-accordion" multi="true">
        @for (message of webSocketState.messages; track message.timestamp) {
          <mat-expansion-panel 
            class="log-expansion-panel" 
            [attr.data-type]="message.type"
            [expanded]="!isMessageExpandable(message)">
            
            <!-- Panel Header - Always Visible -->
            <mat-expansion-panel-header class="log-panel-header">
              <mat-panel-title class="log-panel-title">
                <div class="title-content">
                  <span class="message-icon" [style.color]="parseMessage(message).color">
                    {{ parseMessage(message).icon }}
                  </span>
                  <span class="message-source">{{ parseMessage(message).source }}</span>
                  <span class="message-summary" [style.color]="parseMessage(message).color">
                    {{ getMessageSummary(message) }}
                  </span>
                </div>
              </mat-panel-title>
              <mat-panel-description class="log-panel-description">
                <span class="message-time">{{ formatTimestamp(message.timestamp) }}</span>
              </mat-panel-description>
            </mat-expansion-panel-header>
            
            <!-- Panel Content - Shown When Expanded -->
            <div class="log-panel-content" *ngIf="isMessageExpandable(message)">
              <div class="full-message-text" [style.color]="parseMessage(message).color">
                {{ parseMessage(message).text }}
              </div>
              
              <!-- Additional Data Section -->
              @if (hasDataProperty(message) && getMessageData(message) && Object.keys(getMessageData(message)!).length > 0) {
                <div class="additional-data">
                  <h4>Datos Adicionales:</h4>
                  <div class="data-grid">
                    @for (dataEntry of getDataEntries(message); track dataEntry[0]) {
                      <div class="data-item">
                        <span class="data-key">{{ dataEntry[0] }}:</span>
                        <span class="data-value">{{ formatDataValue(dataEntry[1]) }}</span>
                      </div>
                    }
                  </div>
                </div>
              }
              
              <!-- Raw JSON for Debug Messages -->
              @if (parseMessage(message).icon === '❓') {
                <details class="raw-message">
                  <summary>Ver mensaje original completo</summary>
                  <pre>{{ message | json }}</pre>
                </details>
              }
            </div>
            
          </mat-expansion-panel>
        }
      </mat-accordion>
    }
  </div>
</div>